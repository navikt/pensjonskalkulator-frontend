name: Sanity Backup
on:
  workflow_dispatch:
  schedule:
    # KjÃ¸res kl. 06:00 hver dag
    - cron: "0 6 * * *"
jobs:
  backup-sanity:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    name: Backup Sanity dataset
    steps:
      - uses: actions/checkout@v3

      - name: Set backup file name
        run: echo "FILE_NAME=backup-$(date +%F-%H%M).tar.gz" >> $GITHUB_ENV

      - name: Create backups directory
        run: mkdir -p backups

      - name: Export dataset
        uses: sanity-io/github-action-sanity@cdeffd046eefb565a2ae8c2333f593a5f4012ec2 #with Node v20 required by Sanity-cli
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
        with:
          args: dataset export production backups/${{ env.FILE_NAME }} --project ${{ secrets.SANITY_PROJECT_ID }}

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: ./backups/${{ env.FILE_NAME }}
          destination: pkf/sanity-backups/
          if-no-files-found: error
